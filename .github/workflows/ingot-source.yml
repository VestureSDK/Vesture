name: Ingot Source
on:
  push:
    paths:
      - 'src/**'
      - '.github/**'
      - 'ingot.build.ps1'
    branches:
      - main
  pull_request:
    paths:
      - 'src/**'
      - '.github/**'
      - 'ingot.build.ps1'
    branches:
      - '*'

env:
  NUPKG_DiRECTORY: "./dist"

jobs:
  src-linter:
    name: Linter
    runs-on: ubuntu-24.04
    container: mcr.microsoft.com/dotnet/sdk:9.0.102-noble
    steps:
      - name: Git Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: tree:0
      - uses: ./.github/actions/ingot-setup
        name: Setup
      - name: Linter
        run: dotnet ib ci-src-linter

  src-build:
    needs: src-linter
    name: Build
    runs-on: ubuntu-24.04
    container: mcr.microsoft.com/dotnet/sdk:9.0.102-noble
    steps:
      - name: Git Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: tree:0
      - uses: ./.github/actions/ingot-setup
        name: Setup
      - name: Build
        run: dotnet ib ci-src-build
      - uses: actions/upload-artifact@v4
        name: "Artifact: bin/Release"
        with:
          name: build
          if-no-files-found: error
          retention-days: 1
          path: ./**/bin/*

  src-test:
    needs: src-build
    name: Test
    runs-on: ubuntu-24.04
    container: mcr.microsoft.com/dotnet/sdk:9.0.102-noble
    steps:
      - name: Git Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: tree:0
      - uses: ./.github/actions/ingot-setup
        name: Setup
      - uses: actions/download-artifact@v4
        with:
          name: build
      - name: Test
        run: dotnet ib ci-src-test

  src-pack:
    needs: src-build
    name: Pack
    runs-on: ubuntu-24.04
    container: mcr.microsoft.com/dotnet/sdk:9.0.102-noble
    steps:
      - name: Git Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: tree:0
      - uses: ./.github/actions/ingot-setup
        name: Setup
      - uses: actions/download-artifact@v4
        with:
          name: build
      - name: Pack
        run: |
          dotnet ib ci-src-pack \
            -NupkgDirectory ${{ env.NUPKG_DiRECTORY }}
      - uses: actions/upload-artifact@v4
        name: "Artifact: nupkg"
        with:
          name: nupkg
          if-no-files-found: error
          retention-days: 3
          path: ${{ env.NUPKG_DiRECTORY }}/*.nupkg

  src-publish:
    needs: 
      - src-build
      - src-pack
      - src-test
    name: Publish
    runs-on: ubuntu-24.04
    container: mcr.microsoft.com/dotnet/sdk:9.0.102-noble
    steps:
      - name: Git Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: tree:0
      - uses: ./.github/actions/ingot-setup
        name: Setup
      - uses: actions/download-artifact@v4
        with:
          name: nupkg
          path: ${{ env.NUPKG_DiRECTORY }}
      - name: Push (feedz.io)
        run: |
          dotnet ib ci-src-publish \
            -NupkgDirectory "${{ env.NUPKG_DiRECTORY }}" \
            -NupkgPushSource "https://f.feedz.io/stfbln/ingot/nuget/index.json" \
            -NupkgPushApiKey "${{ secrets.FEEDZ_API_KEY }}"
      - name: Push (nuget.org)
        if: ${{ startsWith(github.event.ref, 'refs/tags') }}
        run: |
          dotnet ib ci-src-publish \
            -NupkgDirectory "${{ env.NUPKG_DiRECTORY }}" \
            -NupkgPushSource "https://api.nuget.org/v3/index.json" \
            -NupkgPushApiKey "${{ secrets.NUGET_ORG_API_KEY }}"
